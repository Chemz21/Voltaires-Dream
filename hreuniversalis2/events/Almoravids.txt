#Events for the Almoravid invasion of Al-Andalus in the late eleventh century 

namespace = almoravids_events

#Turns DAA into MOR
country_event = {
	id = almoravids_events.1
    title = "almoravids_events.1.t"
    desc = "almoravids_events.1.d"
	picture = RELIGIOUS_WARS_eventPicture

	fire_only_once = yes
	major = yes

	mean_time_to_happen = {
		months = 60
	}

	trigger = {
		normal_or_historical_nations = yes
		NOT = { started_in = 1061.1.1 }
		is_year = 1057
		tag = DAA
		dynasty = "al-Murâbit"
		is_at_war = no
	}

	option = {
		name = almoravids_events.1.a
		change_tag = MOR
		add_treasury = 200
		add_prestige = 40
		add_manpower = 5
		if = {
			limit = { MRK = { ai = yes was_player = no } }
			inherit = MRK
		}
		if = {
			limit = { TDL = { ai = yes was_player = no } }
			inherit = TDL
		}
		if = {
			limit = { SOS = { ai = yes was_player = no } }
			inherit = SOS
		}
		if = {
			limit = { TFL = { ai = yes was_player = no } }
			inherit = TFL
		}
		add_country_modifier = {
			name = armed_jihad_m
			duration = 5475
		}
		hidden_effect = {
			set_government_rank = 5
			change_government = monarchy
			add_government_reform = iqta
			set_capital = 4762
			add_accepted_culture = moroccan
			country_event = { id = ideagroups.1 }
		}
	}
}

#Ask for MOR help
country_event = {
    id = almoravids_events.2
    title = "almoravids_events.2.t"
    desc = "almoravids_events.2.d"
    picture = DIPLOMACY_eventPicture

    fire_only_once = yes
    major = yes

    trigger = {
        NOT = { is_year = 1220 }
        NOT = { started_in = 1090.1.1 }
        is_year = 1080
        NOT = { tag = MOR }
        MOR = {
            exists = yes
            religion = ROOT
            dynasty = "al-Murâbit"
            NOT = { war_with = ROOT }
            NOT = { is_rival = ROOT }
        }
        NOT = { war_score = -25 }
        num_of_cities = 12
        at_war_with_religious_enemy = yes
        capital_scope = {
            OR = {
                region = andalusia_region
                region = alentejo_region
                area = murcia_area
            }
        }
        any_owned_province = { has_port = yes }
    }

    mean_time_to_happen = {
        months = 1
    }

    option = {
        name = "almoravids_events.2.a"
        ai_chance = { factor = 100 }
        MOR = {
            country_event = {
                id = almoravids_events.3
                days = 30
            }
        }
        custom_tooltip = almoravids_events.tt.2
    }
    option = {
        name = "almoravids_events.2.b"
        ai_chance = { factor = 0 }
        add_prestige = 20
    }
}

#Taifa asks MOR for help
country_event = {
    id = almoravids_events.3
    title = "almoravids_events.3.t"
    desc = "almoravids_events.3.d"
    picture = CONQUEST_eventPicture

    fire_only_once = yes
    is_triggered_only = yes

    option = {
        name = "almoravids_events.3.a"
        ai_chance = {
            factor = 75
            modifier = {
                factor = 1.5
                alliance_with = FROM
            }
            modifier = {
                factor = 1.5
                any_rival_country = {
                    war_with = FROM
                }
            }
            modifier = {
                factor = 0.5
                is_bankrupt = yes
            }
        }
        add_prestige = 25
        add_treasury = -300
        add_manpower = -20
    	add_truce_with = FROM
        FROM = {
            country_event = {
                id = almoravids_events.4
                days = 30
            }
        }
    }
    option = {
        name = "almoravids_events.3.b"
        ai_chance = {
            factor = 25
        }
        add_prestige = -1
    }
}


#MOR Response
country_event = {
    id = almoravids_events.4
    title = "almoravids_events.4.t"
    desc = "almoravids_events.4.d"
    picture = DIPLOMACY_eventPicture

    fire_only_once = yes
    is_triggered_only = yes

    option = {
        name = "almoravids_events.4.a"
        ai_chance = { factor = 100 }
        add_treasury = 300
        add_manpower = 20
        hidden_effect = {
            set_variable = { which = almoravid1_index value = 20 }
            while = {
                limit = {
                    check_variable = { which = almoravid1_index value = 1 }
                }
                subtract_variable = { which = almoravid1_index value = 1 }
                if = {
                    limit = { capital_scope = { controlled_by = ROOT } }
                    capital_scope = {
                        infantry = ROOT
                    }
                }
                else = {
                    random_owned_province = {
                        infantry = ROOT
                    }
                }
            }
        }
        add_country_modifier = {
            name = almoravid_assistance
            duration = -1
        }
    }
}

#MOR Leaves Andalus
country_event = {
    id = almoravids_events.5
    title = "almoravids_events.5.t"
    desc = "almoravids_events.5.d"
    picture = RELIGIOUS_WARS_eventPicture

    fire_only_once = yes

    trigger = {
        has_country_modifier = almoravid_assistance
        at_war_with_religious_enemy = no
    }

    mean_time_to_happen = {
        months = 12
    }

    option = {
        name = "almoravids_events.5.a"
        ai_chance = { factor = 100 }
        remove_country_modifier = almoravid_assistance
        set_global_flag = mor_leaves_andalus
    }
}

#MOR Intervention
country_event = {
    id = almoravids_events.6
    title = "almoravids_events.6.t"
    desc = "almoravids_events.6.d"
    picture = LAND_MILITARY_eventPicture

    fire_only_once = yes

    trigger = {
        has_global_flag = mor_leaves_andalus
        tag = MOR
        OR = {
            NOT = {
                any_subject_country = {
                    owns = 761
                }
            }
            any_neighbor_country = {
                is_free_or_tributary_trigger = yes
                religion_group = muslim
                capital_scope = {
                     superregion = iberia_superregion
                }
            }
        }
    }

    mean_time_to_happen = {
        months = 12
    }

    option = {
        name = "almoravids_events.6.a"
        ai_chance = { factor = 100 }
        set_country_flag = almoravid_invasion_of_andalusia
        custom_tooltip = almoravids_events.tt.6
        if = {
            limit = {
                NOT = {
                    any_subject_country = {
                        owns = 761
                    }
                }
            }
            761 = {
                owner = {
                    ROOT = {
                        declare_war = PREV
                    }
                    hidden_effect = {
                        country_event = {
                            id = almoravids_events.7
                        }
                    }
                }
            }
        }
        else = {
            random_neighbor_country = {
                limit = {
                    is_free_or_tributary_trigger = yes
                    religion_group = muslim
                    capital_scope = {
                        superregion = iberia_superregion
                    }
                }
                ROOT = {
                    declare_war = PREV
                }
                hidden_effect = {
                    country_event = {
                        id = almoravids_events.7
                    }
                }
            }
        }
    }
    option = {
        name = "almoravids_events.6.b"
        ai_chance = { factor = 0 }
        add_prestige = -10
    }
}

#Devil's Return
country_event = {
    id = almoravids_events.7
    title = "almoravids_events.7.t"
    desc = "almoravids_events.7.d"
    picture = OVEREXTENSION_eventPicture

    fire_only_once = yes
    is_triggered_only = yes

    immediate = {
        hidden_effect = {
            clr_global_flag = mor_leaves_andalus
            761 = { cede_province = MOR }
            andalusia_region = {
                limit = { owned_by = ROOT }
                add_core = FROM
            }
            alentejo_region = {
                limit = { owned_by = ROOT }
                add_core = FROM
            }
            murcia_area = {
                limit = { owned_by = ROOT }
                add_core = FROM
            }
            andalusia_region = {
                limit = { NOT = { owned_by = ROOT } }
                add_claim = FROM
            }
            alentejo_region = {
                limit = { NOT = { owned_by = ROOT } }
                add_claim = FROM
            }
            murcia_area = {
                limit = { NOT = { owned_by = ROOT } }
                add_claim = FROM
            }
        }
    }

    option = {
        name = "almoravids_events.7.a"
        trigger = { ai = yes }
        ai_chance = {
            factor = 50
            modifier = {
                factor = 1.5
                unrest = 0
            }
            modifier = {
                factor = 1.5
                unrest = 3
            }
            modifier = {
                factor = 2
                num_of_rebel_armies = 1
            }
            modifier = {
                factor = 2
                NOT = { stability = 0 }
            }
            modifier = {
                factor = 2
                has_country_modifier = parias_modifier
            }
            modifier = {
                factor = 2
                has_country_modifier = parias_taxes
            }
        }
        every_owned_province = {
            cede_province = MOR
        }
    }

    option = {
        name = "almoravids_events.7.b"
        ai_chance = { factor = 50 }
        add_prestige = 25
        MOR = { declare_war = ROOT }
    }
}

#Surrender?
country_event = {
    id = almoravids_events.8
    title = "almoravids_events.8.t"
    desc = "almoravids_events.8.d"
    picture = OVEREXTENSION_eventPicture

    trigger = {
        is_in_war = {
            attacker_leader = MOR
            defenders = ROOT
        }
        religion_group = muslim
        capital_scope = {
            OR = {
                region = andalusia_region
                region = alentejo_region
                area = murcia_area
            }
        }
        MOR = {
            has_country_flag = almoravid_invasion_of_andalusia
        }
        NOT = { owns = 761 }
        NOT = { tag = MOR }
        NOT = { has_country_flag = mor_invaded }
    }

    mean_time_to_happen = {
        months = 1
    }

    immediate = {
        hidden_effect = {
            set_country_flag = mor_invaded
        }
    }

    option = {
        name = "almoravids_events.8.a"
        trigger = { ai = yes }
        ai_chance = {
            factor = 35
            modifier = {
                factor = 1.5
                unrest = 0
            }
            modifier = {
                factor = 1.5
                unrest = 3
            }
            modifier = {
                factor = 2
                num_of_rebel_armies = 1
            }
            modifier = {
                factor = 2
                NOT = { stability = 0 }
            }
            modifier = {
                factor = 2
                has_country_modifier = parias_modifier
            }
            modifier = {
                factor = 2
                has_country_modifier = parias_taxes
            }
            modifier = {
                factor = 0.4
                num_of_cities = 8
            }
        }
        every_owned_province = {
            cede_province = MOR
        }
    }
    option = {
        name = "almoravids_events.8.b"
        ai_chance = { factor = 65 }
        add_prestige = 25
    }
}
