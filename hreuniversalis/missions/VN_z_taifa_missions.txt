#Taifa missions
#Designed by RetrogMGXII
#Coded by ShyGuy13

vn_taifa_missions_slot_1 = {
    slot = 6
    generic = no
    ai = yes
    potential = {
		OR = { 
			tag = ADU
            AND = {
                capital_scope = {
                    superregion = iberia_superregion
                }
                religion_group = muslim
                OR = {
                    primary_culture = andalucian
                    primary_culture = mozarabic
                }
            }
        }
        NOT = { map_setup = map_setup_random }
    }
    has_country_shield = yes

    vn_taifa_placate_the_christians = {
        position = 2
        icon = mission_african_gold
        required_missions = { vn_taifa_gather_support }
        trigger = {
            calc_true_if = {
                amount = 3
                all_country = {
                    religion_group = christian
                    has_opinion_modifier = {
                        who = ROOT
                        modifier = sent_gift
                    }
                }
                desc = vn_taifa_placate_the_christians.tt
            }
        }
        effect = {
            every_country = {
                limit = {
                    religion_group = christian
                    has_opinion_modifier = {
                        who = ROOT
                        modifier = sent_gift
                    }
                }
                add_truce_with = ROOT
                hidden_effect = {
                    ROOT = { add_truce_with = PREV }
                }
            }
            add_country_modifier = {
                name = taifa_placate_the_christians_mission
                duration = 9125
            }
        }
    }
    vn_taifa_construct_castles = {
        position = 5
        icon = mission_tear_down_spanish_strongholds
        required_missions = { vn_taifa_spoils_of_war vn_taifa_placate_the_christians }
        trigger = {
            num_of_owned_provinces_with = {
                value = 5
                has_fort_trigger = yes
            }
            OR = {
                monthly_mil = 10
                fortification_expert = 1
            }
        }
        effect = {
            hidden_effect = {
                every_owned_province = {
                    limit = {
                        has_fort_trigger = yes
                    }
                    add_base_manpower = 1
                }
            }
            custom_tooltip = vn_taifa_construct_castles.tt
            add_country_modifier = {
                name = taifa_construct_castles_mission
                duration = 9125
            }
        }
    }
}

vn_taifa_missions_slot_2_a = {
    slot = 7
    generic = no
    ai = yes
    potential = {
		OR = { 
			tag = ADU
            AND = {
                capital_scope = {
                    superregion = iberia_superregion
                }
                religion_group = muslim
                OR = {
                    primary_culture = andalucian
                    primary_culture = mozarabic
                }
            }
        }
        NOT = { map_setup = map_setup_random }
    }
    has_country_shield = yes

    vn_taifa_gather_support = {
        position = 1
        icon = mission_restore_trade_superiority
        required_missions = { }
        trigger = {
            calc_true_if = {
                amount = 3
                all_ally = {
                    capital_scope = {
                        superregion = iberia_superregion
                    }
                    has_opinion = {
                        who = ROOT
                        value = 150
                    }
                }
                desc = vn_taifa_gather_support.tt
            }
        }
        effect = {
            add_yearly_manpower = 1
            add_country_modifier = {
                name = taifa_gather_support_mission
                duration = 9125
            }
        }
    }
}

vn_taifa_missions_slot_3 = {
    slot = 8
    generic = no
    ai = yes
    potential = {
		OR = { 
			tag = ADU
            AND = {
                capital_scope = {
                    superregion = iberia_superregion
                }
                religion_group = muslim
                OR = {
                    primary_culture = andalucian
                    primary_culture = mozarabic
                }
            }
        }
        NOT = { map_setup = map_setup_random }
    }
    has_country_shield = yes

    vn_taifa_protect_the_locals = {
        position = 1
        icon = mission_afghan_frontier
        required_missions = { }
		trigger = {
            stability = 2
            is_at_war = no
			capital_scope = {
				area_for_scope_province = {
					type = all
					owned_by = ROOT
                    is_core = ROOT
                    NOT = { devastation = 1 }
				}
			}
		}
        effect = {
            capital_scope = {
                add_base_tax = 1
                add_latest_building = {
					trade = yes
					builder = ROOT
				}
            }
        }
    }
    vn_taifa_continue_the_fitna = {
        position = 2
        icon = mission_eliminate_pretenders
        required_missions = { vn_taifa_gather_support vn_taifa_protect_the_locals vn_taifa_promote_mozarabs }
		trigger = {
            has_regency = no
            num_of_generals = 2
            OR = {
                army_size = 25
                army_size_percentage = 1
            }
            land_maintenance = 1
            is_subject = no
		}
        effect = {
            add_army_tradition = 10
            add_army_professionalism = 0.025
            iberia_superregion = {
                limit = {
                    NOT = { is_core = ROOT }
                    NOT = { is_permanent_claim = ROOT }
                    owner = {
                        religion_group = muslim
                        OR = {
                            primary_culture = mozarabic
                            primary_culture = andalucian
                        }
                    }
                }
                add_permanent_claim = ROOT
            } 
        }
    }
    vn_taifa_conquer_cordoba = {
        position = 3
        icon = mission_fortify_mandu
        required_missions = { vn_taifa_continue_the_fitna }
        provinces_to_highlight = {
            area = cordoba_area
            NOT = { owned_by = ROOT }
        }
        trigger = {
            2670 = {
                owned_by = ROOT
                is_core = ROOT
            }
            num_of_owned_provinces_with = {
                value = 5
                area = cordoba_area
            }
        }
        effect = {
            add_legitimacy = 10
            add_prestige = 10
            cordoba_area = {
                limit = { owned_by = ROOT }
                add_nationalism = -5
            }
        }
    }
    vn_taifa_restore_cordoba = {
        position = 4
        icon = mission_mal_riches_of_trade
        required_missions = { vn_taifa_conquer_cordoba }
        trigger = {
            OR = {
                monthly_adm = 10
                artist = 1
            }
            prestige = 75
            has_reached_government_reform_tier = { tier_3 = yes }
        }
        effect = {
            add_adm_power = 75
        }
    }
    vn_taifa_restore_andalusia = {
        position = 5
        icon = mission_al_andalus
        required_missions = { vn_taifa_restore_cordoba }
        provinces_to_highlight = {
            owner = {
                NOT = { tag = ROOT }
                capital_scope = {
                    superregion = iberia_superregion
                }
                religion_group = muslim
                OR = {
                    total_development = 30
                    NOT = { is_subject = ROOT }
                }
            }
        }
        trigger = {
            tag = ADU
            if = {
                limit = { has_dlc = "Common Sense" }
                legitimacy_equivalent = 100
            }
            else_if = {
                limit = { government = monarchy }
                legitimacy = 100
            }
            else_if = {
                limit = { government = republic }
                republican_tradition = 100
            }
            NOT = { average_unrest = 1 }
            NOT = { corruption = 1 }
            NOT = { num_of_rebel_controlled_provinces = 1 }
            NOT = { num_of_rebel_armies = 1 }
        }
        effect = {
            add_stability_or_adm_power = yes
            add_prestige = 25
            add_country_modifier = {
                name = taifa_restore_andalusia_mission
                duration = 18250
            }
        }
    }
}

vn_taifa_missions_slot_4 = {
    slot = 9
    generic = no
    ai = yes
    potential = {
		OR = { 
			tag = ADU
            AND = {
                capital_scope = {
                    superregion = iberia_superregion
                }
                religion_group = muslim
                OR = {
                    primary_culture = andalucian
                    primary_culture = mozarabic
                }
            }
        }
        NOT = { map_setup = map_setup_random }
    }
    has_country_shield = yes

    vn_taifa_promote_mozarabs = {
        position = 1
        icon = mission_cope_with_refugees
        required_missions = { }
        trigger = {
            if = {
                limit = { has_estate = estate_dhimmi }
                estate_loyalty = {
                    estate = estate_dhimmi
                    loyalty = 60
                }
                has_estate_privilege = estate_dhimmi_dhimmi_nobles
            }
            else = {
                stability = 2
                all_owned_province = {
					NOT = { unrest = 1 }
				}
            }
        }
        effect = {
            if = {
                limit = {
                    NOT = {
                        accepted_culture = mozarabic
                        primary_culture = mozarabic
                    }
                }
                add_accepted_culture = mozarabic
            }
            else_if = {
                limit = {
                    NOT = {
                        accepted_culture = andalucian
                        primary_culture = andalucian
                    }
                }
                add_accepted_culture = andalucian
            }
            else = {
                add_dip_power = 75
            }
            custom_tooltip = vn_lem_recover_from_crusade.tt
            hidden_effect = {
                every_owned_province = {
                    add_local_autonomy = -5
                }
            }
        }
    }
    vn_taifa_cultural_splendor = {
        position = 3
        icon = mission_patronize_art_and_religion
        required_missions = { vn_taifa_summon_a_council vn_taifa_continue_the_fitna }
        provinces_to_highlight = {
			OR = {
				AND = {
					is_capital_of = ROOT
					OR = {
						NOT = { development = 20 }
						NOT = { num_of_times_improved_by_owner = 5 }
					}
				}
				AND = {
					NOT = { province_id = 2670 }
                    religion_group = muslim
                    NOT = { is_capital_of = ROOT }
                    higher_development_than = PREV
				}
			}
        }
		trigger = {
            capital_scope = {
                development = 20
                num_of_times_improved_by_owner = 5 
                culture = ROOT
                religion = ROOT
            }
            custom_trigger_tooltip = {
                tooltip = vn_taifa_cultural_splendor.tt
                capital_scope = {
                    NOT = {
                        iberia_superregion = {
                            NOT = { province_id = 2670 }
                            religion_group = muslim
                            NOT = { is_capital_of = ROOT }
                            higher_development_than = PREV
                        }
                    }
                }
            }
		}
        effect = {
            add_country_modifier = {
                name = taifa_cultural_splendor_mission_a
                duration = 9125
            }
            capital_scope = {
                add_province_modifier = {
                    name = taifa_cultural_splendor_mission_b
                    duration = 9125
                }
            }
        }
    }
    vn_taifa_productive_continent = {
        position = 4
        icon = mission_secure_khandesh
        required_missions = { vn_taifa_cultural_splendor vn_taifa_conquer_cordoba }
        trigger = {
            is_in_deficit = no
            is_bankrupt = no
            NOT = { inflation = 1 }
            monthly_income = 25
        }
        effect = {
            add_mercantilism = 1
            add_country_modifier = {
                name = taifa_productive_continent_mission
                duration = 9125
            }
        }
    }
    vn_taifa_proclaim_sultanate = {
        position = 5
        icon = mission_restore_faith_in_the_throne
        required_missions = { vn_taifa_productive_continent vn_taifa_berber_support vn_taifa_restore_cordoba }
        provinces_to_highlight = {
            is_core = ROOT
            NOT = { owned_by = ROOT }
        }
        trigger = {
            has_disaster = no
            is_subject = no
            all_core_province = {
                owned_by = ROOT
            }
            num_of_owned_provinces_with = {
                value = 75
                superregion = iberia_superregion
            }
        }
        effect = {
            if = {
                limit = { NOT = { government_rank = 5 } }
                set_government_rank = 5
            }
        }
    }
}

vn_taifa_missions_slot_5 = {
    slot = 10
    generic = no
    ai = yes
    potential = {
		OR = { 
			tag = ADU
            AND = {
                capital_scope = {
                    superregion = iberia_superregion
                }
                religion_group = muslim
                OR = {
                    primary_culture = andalucian
                    primary_culture = mozarabic
                }
            }
        }
        NOT = { map_setup = map_setup_random }
    }
    has_country_shield = yes

    vn_taifa_summon_a_council = {
        position = 2
        icon = mission_ottoman_harem
        required_missions = { }
        trigger = {
            has_3_advisors_trigger = yes
        }
        effect = {
            add_country_modifier = {
                name = taifa_summon_a_council_mission
                duration = 9125
            }
        }
    }
    vn_taifa_foreign_military_aid = {
        position = 3
        icon = mission_son_military_expertise
        required_missions = { vn_taifa_summon_a_council }
        provinces_to_highlight = {
            is_capital = yes
            owner = {
                culture_group = maghrebi
                num_of_cities = 15
                NOT = {
                    has_opinion_modifier = {
                        who = ROOT
                        modifier = improved_relation
                        value = 75
                    }
                }
            }
        }
        trigger = {
            OR = {
                monthly_dip = 10
                diplomat = 1
            }
			any_country = {
				capital_scope = {
					culture_group = maghrebi
				}
                has_opinion_modifier = {
                    who = ROOT
                    modifier = improved_relation
                    value = 75
                }
                num_of_cities = 15
			}
        }
        effect = {
            add_mil_power = 50
            add_country_modifier = {
                name = taifa_foreign_military_aid_mission
                duration = 9125
            }
        }
    }
    vn_taifa_berber_support = {
        position = 4
        icon = mission_traverse_the_sahara
        required_missions = { vn_taifa_foreign_military_aid }
        trigger = {
            custom_trigger_tooltip = {
				tooltip = vn_taifa_berber_support.tt
				has_country_flag = won_war_with_berber_mercs
			}
        }
        effect = {

            tangiers_area = {
                limit = {
                    NOT = { is_core = ROOT }
                    NOT = { is_permanent_claim = ROOT }
                }
                add_permanent_claim = ROOT
            }
            add_country_modifier = {
                name = taifa_berber_support_mission
                duration = 9125
            }
        }
    }
    vn_taifa_conquer_ceuta = {
        position = 5
        icon = mission_arabian_sea_trade
        required_missions = { vn_taifa_berber_support }
        provinces_to_highlight = {
            area = tangiers_area
            NOT = { country_or_non_sovereign_subject_holds = ROOT }
        }
        trigger = {
            tangiers_area = {
                type = all
                country_or_non_sovereign_subject_holds = ROOT
            }
        }
        effect = {
            4625 = {
                if = {
					limit = {
						province_has_center_of_trade_of_level = 1
						NOT = { province_has_center_of_trade_of_level = 3 }
					}
					add_center_of_trade_level = 1
				}
				else_if = {
					limit = {
						NOT = { province_has_center_of_trade_of_level = 1 }
					}
					center_of_trade = 1
				}
				else = {
					add_base_tax = 1
					add_base_production = 1
					add_base_manpower = 1
				}  
            }
            add_country_modifier = {
                name = taifa_conquer_ceuta_mission
                duration = 9125
            }
        }
    }
}